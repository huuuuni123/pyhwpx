<!doctype html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ïª¨Îü¨ Ïä§ÌäúÎîîÏò§ Pro ‚Äì ÎåÄÏãúÎ≥¥Îìú ÌÜµÌï©</title>
<!-- QR (ÏòµÏÖò) -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<!-- Google API (Drive Í≥µÏú† ÏòµÏÖò) -->
<script src="https://apis.google.com/js/api.js"></script>
<style>
  :root{
    /* Dark */
    --bg:#0b0c10; --panel:#11131a; --text:#e7e9ee; --muted:#9aa3b2;
    --pri:#6C5CE7; --accent:#10B981; --border:#1f2330; --ring:#6C5CE788;
    --radius:16px;
  }
  [data-theme="light"]{
    --bg:#f5f7fb; --panel:#ffffff; --text:#0b0c10; --muted:#6b7280;
    --pri:#5B74F9; --accent:#0EA5A6; --border:#e5e8f1; --ring:#5B74F966;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
       background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  .header-row{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
  .title h1{margin:0;font-weight:800;letter-spacing:-.02em;font-size:28px;display:flex;align-items:center;gap:10px}
  .title p{margin:4px 0 0;color:var(--muted)}
  .muted{color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--border);background:var(--panel);color:var(--text);
       padding:8px 14px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
       transition:all .15s ease-out;font-weight:600;white-space:nowrap;}
  .btn:hover{box-shadow:0 0 0 2px var(--ring)}
  .btn.icon-btn{padding:8px;font-size:16px;height:38px;min-width:38px;justify-content:center}
  .btn.ghost{background:transparent}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  .toolbar-group {display:flex; gap:6px; padding:6px; border: 1px solid var(--border); border-radius:12px; background:var(--panel)}
  select, option{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px;font-weight:600}

  .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;background:transparent;margin-top:24px}
  .tab-btn{padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--panel);color:var(--muted);cursor:pointer;font-weight:700}
  .tab-btn.active{color:var(--text);box-shadow:0 0 0 2px var(--ring)}

  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
  .panel h3{margin:0;padding:16px 18px;border-bottom:1px solid var(--border);font-size:16px;font-weight:800;letter-spacing:.01em}
  .panel .content{padding:18px}
  .grid{display:grid;gap:16px}
  .grid.cols-auto{grid-template-columns:repeat(auto-fit, minmax(320px, 1fr))}
  .row-wrap{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
  .preview{height:160px;border-radius:12px;border:1px solid var(--border);transition: background .2s;}
  input[type="color"]{min-width:48px;height:40px;border-radius:10px;border:1px solid var(--border);background:transparent;padding:4px}
  .input{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:10px;padding:8px 12px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .slider-group{display:flex;flex-direction:column;gap:4px;}
  .slider-label{display:flex;justify-content:space-between;align-items:center;font-size:14px}
  .slider{width:100%;-webkit-appearance:none;background:transparent;cursor:pointer}
  .slider::-webkit-slider-runnable-track{height:6px;background:linear-gradient(to right, #2222, #5555);border-radius:3px}
  .slider::-webkit-slider-thumb{ -webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:var(--text);border:3px solid var(--pri);margin-top:-6px}

  .swatch-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(60px, 1fr));gap:8px}
  .sw{position:relative;border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;display:flex;flex-direction:column;min-height:60px;}
  .sw .ink{position:relative;flex:1;transition:transform .15s}
  .sw:hover .ink{transform:scale(1.03)}
  .sw.selected{outline:2px solid var(--pri); outline-offset:0}

  .palette-item .swatch-meta{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:6px;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);color:#fff;}
  .palette-item .swatch-name{font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;text-align:left;}
  .palette-item .actions{display:flex;gap:6px;align-items:center;}
  .palette-item .action-btn{width:26px;height:26px;border-radius:8px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.18);display:grid;place-items:center;color:#fff;font-size:12px;cursor:pointer;transition:background .15s,border-color .15s;}
  .palette-item .action-btn:hover{background:rgba(255,255,255,0.32);border-color:rgba(255,255,255,0.45)}
  .palette-item.locked .swatch-meta{background:rgba(0,0,0,.55)}

  .code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px;white-space:nowrap;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:12px}

  /* Scroll areas */
  .scroll-area{max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;background:transparent}
  #bigGridWrap.scroll-area{max-height:460px}
  .scroll-area::-webkit-scrollbar{height:10px;width:10px}
  .scroll-area::-webkit-scrollbar-thumb{background:#2a304366;border-radius:999px}
  .scroll-area::-webkit-scrollbar-track{background:#00000011;border-radius:999px}

  /* Hovercard */
  .hovercard{position:fixed;z-index:60;width:260px;background:#ffffff;border-radius:12px;box-shadow:0 18px 50px rgba(0,0,0,.45);display:none;overflow:hidden;border:1px solid #e5e7eb}
  .hc-top{height:140px}
  .hc-bottom{background:#ffffff;color:#111827;padding:12px}
  .hc-title{font-weight:800;letter-spacing:-.01em}
  .hc-meta{color:#4b5563;font-size:12px;margin-top:2px}
  .hc-row{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
  .hc-chip{font-family:ui-monospace,Menlo,monospace;border:1px solid #e5e7eb;padding:2px 6px;border-radius:8px;background:#f8fafc}
  .hc-actions{display:flex;gap:6px;margin-top:10px}
  .hc-btn{border:1px solid #e5e7eb;background:#f3f4f6;color:#111827;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer}
  .hc-pin-actions{position:absolute;top:8px;right:8px;display:flex;gap:6px;}
  .hc-pin-btn{background:rgba(0,0,0,.45);color:#fff;border:none;border-radius:8px;width:28px;height:28px;font-size:12px;cursor:pointer;display:grid;place-items:center;}
  .pinned{outline:2px solid var(--ring)}

  /* Mini grid popover */
  .popover{position:absolute;z-index:70;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.25);padding:10px;display:none}
  .mini-grid{display:grid;grid-template-columns:repeat(12, 16px);gap:6px}
  .mini-cell{width:16px;height:16px;border-radius:4px;border:1px solid var(--border);cursor:pointer}

  /* Modal (QR) */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:90;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
  .modal-overlay.visible{opacity:1;pointer-events:auto}
  .modal-content{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:24px;width:90%;max-width:400px;text-align:center;}
  #qrcode{margin:16px auto 0; padding:16px; background:white; border-radius:8px; width:fit-content;}

  /* WCAG cards */
  .wcag-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .wcag-box{border-radius:12px;height:120px;padding:12px;display:flex;flex-direction:column;justify-content:space-between;gap:6px;border:1px solid rgba(0,0,0,0.08);backdrop-filter:blur(4px)}
  [data-theme="light"] .wcag-box{border:1px solid rgba(0,0,0,0.12)}
  .wcag-title{font-weight:700;font-size:14px}
  .contrast-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .contrast-pill{padding:2px 10px;border-radius:999px;font-size:12px;font-weight:700;letter-spacing:.01em;display:inline-flex;align-items:center;gap:4px}
  .contrast-pill.pass{background:rgba(16,185,129,0.22);color:#d1fae5}
  .contrast-pill.warn{background:rgba(245,158,11,0.24);color:#fef3c7}
  .contrast-pill.fail{background:rgba(239,68,68,0.25);color:#fee2e2}
  .contrast-value{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-weight:700}
  .wcag-note{font-size:12px;opacity:0.85}
  [data-theme="light"] .contrast-pill.pass{color:#047857}
  [data-theme="light"] .contrast-pill.warn{color:#b45309}
  [data-theme="light"] .contrast-pill.fail{color:#b91c1c}
</style>
</head>
<body>
<div class="container">
  <div class="header-row">
    <div class="title">
      <h1>üé® Ïª¨Îü¨ Ïä§ÌäúÎîîÏò§ Pro</h1>
      <p>ÎåÄÏãúÎ≥¥Îìú Ï§ëÏã¨ ¬∑ ÎùºÏù¥Ìä∏/Îã§ÌÅ¨ ÌÖåÎßà ¬∑ ÎØ∏Îãà Í∑∏Î¶¨Îìú ÏÑ†ÌÉù</p>
    </div>
    <div class="toolbar">
      <select id="palSelect" aria-label="ÌåîÎ†àÌä∏ ÏÑ†ÌÉù"></select>
      <div class="toolbar-group">
        <button class="btn icon-btn" id="btn-new" title="ÏÉà ÌåîÎ†àÌä∏">‚ûï</button>
        <button class="btn icon-btn" id="btn-save" title="Ï†ÄÏû•">üíæ</button>
        <button class="btn icon-btn" id="btn-dup" title="Î≥µÏ†ú">üìã</button>
        <button class="btn icon-btn" id="btn-del" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
      </div>
      <div class="toolbar-group">
        <button class="btn" id="btn-import">Í∞ÄÏ†∏Ïò§Í∏∞</button>
        <button class="btn" id="btn-export">JSON</button>
        <button class="btn" id="btn-export-ase">ASE</button>
        <button class="btn icon-btn" id="btn-share" title="QR Í≥µÏú†">üîó</button>
      </div>
      <div class="toolbar-group">
        <button class="btn" id="btn-drive-auth">Drive Ïó∞Í≤∞</button>
        <button class="btn" id="btn-drive-share">Drive Í≥µÏú†</button>
      </div>
      <div class="toolbar-group">
        <button class="btn" id="btn-theme">üåô Îã§ÌÅ¨</button>
      </div>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <button class="tab-btn active" data-tab="dashboard" role="tab" aria-controls="tab-dashboard">ÎåÄÏãúÎ≥¥Îìú</button>
    <button class="tab-btn" data-tab="ai" role="tab" aria-controls="tab-ai">AI &amp; Ïù¥ÎØ∏ÏßÄ</button>
    <button class="tab-btn" data-tab="palette" role="tab" aria-controls="tab-palette">ÌåîÎ†àÌä∏</button>
  </div>

  <main style="margin-top:24px;">
    <section id="tab-dashboard">
      <div class="grid cols-auto">
        <div class="panel">
          <h3>Î©îÏù∏ ÏÉâÏÉÅ</h3>
          <div class="content" style="display:flex;flex-direction:column;gap:16px">
            <div id="preview1" class="preview" aria-label="ÎØ∏Î¶¨Î≥¥Í∏∞"></div>

            <!-- Í∑∏ÎùºÎîîÏñ∏Ìä∏ ÏÉùÏÑ±Í∏∞ (Ïù¥Îèô) -->
            <div class="row-wrap" style="gap:12px;align-items:flex-start;flex-wrap:wrap">
              <div class="row-wrap" style="gap:10px">
                <input type="color" id="colorInput1">
                <input class="input" id="hexInput1" placeholder="#6C5CE7" maxlength="7">
                <button class="btn icon-btn" id="eyedrop1" title="Ïä§Ìè¨Ïù¥Ìä∏">üíß</button>
                <button class="btn icon-btn" id="openMiniGrid" title="Í∑∏Î¶¨Îìú ÏÑ†ÌÉù">üü¶</button>
                <button class="btn" id="addCurrent">ÌåîÎ†àÌä∏Ïóê Ï∂îÍ∞Ä</button>
              </div>

              <div class="row-wrap" style="gap:10px; border-left:1px solid var(--border); padding-left:12px">
                <label>ÏãúÏûë:</label> <input type="color" id="colorStart" />
                <input class="input" id="hexStart" maxlength="7" placeholder="#6C5CE7"/>
                <label>ÎÅù:</label> <input type="color" id="colorEnd" />
                <input class="input" id="hexEnd" maxlength="7" placeholder="#10B981"/>
                <button class="btn" id="copyCss">CSS Î≥µÏÇ¨</button>
              </div>
              <div id="gradPrev" class="preview" style="height:90px; width:100%"></div>
              <div class="code" id="cssCode" style="width:100%"></div>
            </div>

            <!-- ÎØ∏Îãà Í∑∏Î¶¨Îìú ÌåùÏò§Î≤Ñ -->
            <div id="miniPopover" class="popover" role="dialog" aria-modal="true">
              <div id="miniGrid" class="mini-grid" aria-label="ÎØ∏Îãà ÏÉâÏÉÅÌëú"></div>
            </div>

            <div class="grid" style="grid-template-columns:repeat(3,1fr)">
              <div class="slider-group">
                <div class="slider-label"><span>ÏÉâÏÉÅ</span><span class="muted" id="hVal">0¬∞</span></div>
                <input class="slider" type="range" min="0" max="359" value="260" id="hSl" aria-label="Hue"/>
              </div>
              <div class="slider-group">
                <div class="slider-label"><span>Ï±ÑÎèÑ</span><span class="muted" id="sVal">0%</span></div>
                <input class="slider" type="range" min="0" max="100" value="70" id="sSl" aria-label="Saturation"/>
              </div>
              <div class="slider-group">
                <div class="slider-label"><span>Î™ÖÎèÑ</span><span class="muted" id="lVal">0%</span></div>
                <input class="slider" type="range" min="0" max="100" value="60" id="lSl" aria-label="Lightness"/>
              </div>
            </div>
            <div class="row-wrap">
              <button class="btn" id="copyHex1">HEX Î≥µÏÇ¨</button>
            </div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:16px;">
          <div class="panel">
            <h3>Î™ÖÏïî ÎåÄÎπÑ (WCAG)</h3>
            <div class="content">
              <div class="wcag-grid">
                <div id="wcagW" class="wcag-box"></div>
                <div id="wcagB" class="wcag-box"></div>
              </div>
            </div>
          </div>

          <div class="panel">
            <h3>ÌåîÎ†àÌä∏ ÎØ∏Î¶¨Î≥¥Í∏∞</h3>
            <div class="content">
              <div class="row-wrap" style="justify-content:space-between">
                <div class="muted"><span id="countLabel">0</span>Í∞ú ÏÉâÏÉÅ</div>
                <button class="btn ghost" id="resetUnlocked">Ïû†Í∏à Ïô∏ Ï¥àÍ∏∞Ìôî</button>
              </div>
              <div id="miniGridWrap" class="scroll-area" style="margin-top:12px">
                <div id="miniPalGrid" class="swatch-grid"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ï∂îÏ≤ú/Ï°∞Ìôî -->
      <div class="panel" style="margin-top:16px">
        <h3>Ï∂îÏ≤ú ¬∑ Í∏∞Î≥∏ Ï°∞Ìôî</h3>
        <div class="content">
          <div id="harmonyGrid" class="grid cols-auto"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:16px">
        <h3>ÌôïÏû• ÏÉâÏòÅÏó≠ ¬∑ ÎîîÏûêÏù¥ÎÑàÏö©</h3>
        <div class="content">
          <div id="extraRegions" class="grid cols-auto"></div>
        </div>
      </div>
    </section>

    <section id="tab-ai" hidden>
      <div class="panel">
        <h3>Ïù¥ÎØ∏ÏßÄÏóêÏÑú ÏÉâÏÉÅ Ï∂îÏ∂ú</h3>
        <div class="content">
          <div id="imageDropzone" style="border:2px dashed var(--border); border-radius:12px; padding:40px; text-align:center; cursor:pointer;">
            <p class="muted">Ïù¥ÎØ∏ÏßÄÎ•º ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.</p>
          </div>
          <img id="imagePreview" alt="ÎØ∏Î¶¨Î≥¥Í∏∞" style="max-width:100%; max-height:200px; border-radius:10px; border:1px solid var(--border); display:none; margin-top:16px;"/>
          <div id="imageResult" style="margin-top:16px; display:none;">
            <h4>Ï∂îÏ∂úÎêú ÏÉâÏÉÅ</h4>
            <div id="imageResultGrid" class="swatch-grid"></div>
            <div class="row-wrap" style="margin-top:16px;">
              <button class="btn" id="addImageToPalette">ÏÑ†ÌÉù ÏÉâÏÉÅ ÌåîÎ†àÌä∏Ïóê Ï∂îÍ∞Ä</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-palette" hidden>
      <div class="panel">
        <h3>Ï†ÑÏ≤¥ ÌåîÎ†àÌä∏</h3>
        <div class="content">
          <div class="row-wrap" style="justify-content:space-between">
            <div class="muted"><span id="countLabel2">0</span>Í∞ú ÏÉâÏÉÅ</div>
          </div>
          <div id="bigGridWrap" class="scroll-area" style="margin-top:12px">
            <div id="bigGrid" class="swatch-grid" style="grid-template-columns:repeat(auto-fill, minmax(80px, 1fr))"></div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Hover Card -->
<div id="hoverCard" class="hovercard">
  <div class="hc-top" id="hcTop"></div>
  <div class="hc-pin-actions">
    <button class="hc-pin-btn" id="hcPin" title="Í≥†Ï†ï/Ìï¥Ï†ú">üìå</button>
    <button class="hc-pin-btn" id="hcClose" title="Îã´Í∏∞">‚úï</button>
  </div>
  <div class="hc-bottom">
    <div class="hc-title" id="hcName"></div>
    <div class="hc-meta" id="hcMeta"></div>
    <div class="hc-row"><span>HEX</span><span class="hc-chip" id="hcHex"></span></div>
    <div class="hc-row"><span>RGB</span><span class="hc-chip" id="hcRgb"></span></div>
    <div class="hc-actions">
      <button class="hc-btn" id="hcCopyHex">HEX Î≥µÏÇ¨</button>
      <button class="hc-btn" id="hcCopyRgb">RGB Î≥µÏÇ¨</button>
      <button class="hc-btn" id="hcAdd">ÌåîÎ†àÌä∏Ïóê Ï∂îÍ∞Ä</button>
    </div>
  </div>
</div>

<!-- Í≥µÏú† Î™®Îã¨ -->
<div id="modal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <h3 id="modal-title">ÌåîÎ†àÌä∏ Í≥µÏú†</h3>
    <p id="modal-text" class="muted">QR ÎòêÎäî ÎßÅÌÅ¨Î°ú Í≥µÏú†Ìï©ÎãàÎã§.</p>
    <div id="qrcode"></div>
    <input id="share-url" class="input" style="width:100%; margin-top:16px; text-align:center;" readonly>
    <div class="row-wrap" style="justify-content:center; margin-top:16px;">
      <button class="btn" id="copy-url-btn">ÎßÅÌÅ¨ Î≥µÏÇ¨</button>
      <button class="btn ghost" id="modal-close-btn">Îã´Í∏∞</button>
    </div>
  </div>
</div>

<input type="file" id="fileInput" hidden multiple />

<script>
(function(){
  'use strict';

  /* ===== Drive API ÏÑ§Ï†ï (Í∞í Ï±ÑÏõåÎÑ£ÏúºÎ©¥ ÌôúÏÑ±Ìôî) ===== */
  const DRIVE_CFG = {
    API_KEY: 'PUT_YOUR_API_KEY_HERE',
    CLIENT_ID: 'PUT_YOUR_OAUTH_CLIENT_ID_HERE',
    SCOPE: 'https://www.googleapis.com/auth/drive.file',
    FOLDER_ROOT: 'Color Palettes'
  };

  const App = {
    state:{
      palettesDB:[],
      currentPaletteId:null,
      get palette(){ const p=this.palettesDB.find(p=>p.id===this.currentPaletteId); return p? p.colors:[]; },
      set palette(colors){ const i=this.palettesDB.findIndex(p=>p.id===this.currentPaletteId); if(i>-1) this.palettesDB[i].colors=colors; },
      currentColor:"#6C5CE7",
      gradient:{start:"#6C5CE7", end:"#10B981"},
      hoverCard:{pinned:false, hex:null},
      gapiInited:false, driveAuthed:false
    },
    utils:{
      clamp:(n,min,max)=>Math.min(max,Math.max(min,n)),
      hexToRgb:(hex)=>{const h=(hex||'#000000').replace('#',''); const n=h.length===3?h.split('').map(x=>x+x).join(''):h.padEnd(6,'0'); return {r:parseInt(n.slice(0,2)||'00',16), g:parseInt(n.slice(2,4)||'00',16), b:parseInt(n.slice(4,6)||'00',16)};},
      rgbToHex:({r,g,b})=>"#"+[r,g,b].map(v=>Math.min(255,Math.max(0,v)).toString(16).padStart(2,'0')).join('').toUpperCase(),
      rgbToHsl:({r,g,b})=>{r/=255; g/=255; b/=255; const max=Math.max(r,g,b), min=Math.min(r,g,b); let h=0,s=0; const l=(max+min)/2; if(max!==min){const d=max-min; s=l>0.5? d/(2-max-min): d/(max+min); switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;default:h=(r-g)/d+4;} h/=6;} return {h:Math.round(h*360)%360,s:Math.round(s*100),l:Math.round(l*100)};},
      hslToRgb:({h,s,l})=>{h=((h%360)+360)%360; h/=360; s=Math.min(100,Math.max(0,s))/100; l=Math.min(100,Math.max(0,l))/100; if(s===0){const v=Math.round(l*255); return {r:v,g:v,b:v};} const hue2rgb=(p,q,t)=>{if(t<0)t+=1; if(t>1)t-=1; if(t<1/6)return p+(q-p)*6*t; if(t<1/2)return q; if(t<2/3)return p+(q-p)*(2/3-t)*6; return p;}; const q=l<0.5? l*(1+s): l+s-l*s; const p=2*l-q; return {r:Math.round(hue2rgb(p,q,h+1/3)*255), g:Math.round(hue2rgb(p,q,h)*255), b:Math.round(hue2rgb(p,q,h-1/3)*255)};},
      srgbToLinear:(v)=>{const s=v/255; return s<=0.04045? s/12.92: Math.pow((s+0.055)/1.055,2.4);},
      linearToSrgb:(v)=>{const s=v<=0.0031308? v*12.92: 1.055*Math.pow(v,1/2.4)-0.055; return Math.round(App.utils.clamp(s,0,1)*255);},
      mixColors:(hexA,hexB,amount=0.5)=>{
        amount=App.utils.clamp(amount,0,1);
        const a=App.utils.hexToRgb(hexA), b=App.utils.hexToRgb(hexB);
        const blend=(ca,cb)=>{
          const la=App.utils.srgbToLinear(ca);
          const lb=App.utils.srgbToLinear(cb);
          return App.utils.linearToSrgb(la*(1-amount)+lb*amount);
        };
        return App.utils.rgbToHex({r:blend(a.r,b.r), g:blend(a.g,b.g), b:blend(a.b,b.b)});
      },
      setL:(hex,l)=>{const hsl=App.utils.rgbToHsl(App.utils.hexToRgb(hex)); return App.utils.rgbToHex(App.utils.hslToRgb({h:hsl.h,s:hsl.s,l:Math.min(100,Math.max(0,l))}));},
      setS:(hex,s)=>{const hsl=App.utils.rgbToHsl(App.utils.hexToRgb(hex)); return App.utils.rgbToHex(App.utils.hslToRgb({h:hsl.h,s:Math.min(100,Math.max(0,s)),l:hsl.l}));},
      shiftHue:(hex,deg)=>{const hsl=App.utils.rgbToHsl(App.utils.hexToRgb(hex)); return App.utils.rgbToHex(App.utils.hslToRgb({h:(hsl.h+deg+360)%360,s:hsl.s,l:hsl.l}));},
      luminance:({r,g,b})=>{const s=[r,g,b].map(v=>{v/=255; return v<=0.03928? v/12.92: Math.pow((v+0.055)/1.055,2.4)}); return 0.2126*s[0]+0.7152*s[1]+0.0722*s[2];},
      contrastRatio:(a,b)=>{const L1=App.utils.luminance(App.utils.hexToRgb(a)); const L2=App.utils.luminance(App.utils.hexToRgb(b)); return (Math.max(L1,L2)+0.05)/(Math.min(L1,L2)+0.05);},
      copyText: async (t)=>{try{await navigator.clipboard.writeText(t); App.utils.toast('Î≥µÏÇ¨ÌñàÏäµÎãàÎã§.');}catch(e){App.utils.toast('Î≥µÏÇ¨ Ïã§Ìå®');}},
      toast:(t)=>{const el=document.createElement('div'); el.textContent=t; el.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);padding:8px 16px;border:1px solid var(--border);background:var(--panel);border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.25);font-size:14px;color:var(--text);z-index:100;'; document.body.appendChild(el); setTimeout(()=>el.remove(),1500);},
      colorNameKo:(hex)=>{const {h,s,l}=App.utils.rgbToHsl(App.utils.hexToRgb(hex)); if(s<10) return l>85?'Ìù∞ÏÉâ Í≥ÑÏó¥': l<15?'Í≤ÄÏ†ï Í≥ÑÏó¥':'ÌöåÏÉâ Í≥ÑÏó¥'; const tone=l>75?'Î∞ùÏùÄ ': l<30?'Ïñ¥ÎëêÏö¥ ': s>65?'ÏÑ†Î™ÖÌïú ':'Ï∞®Î∂ÑÌïú '; const band=h=>{if(h<15||h>=345)return'Î†àÎìú'; if(h<35)return'Ïò§Î†åÏßÄ'; if(h<55)return'ÏòêÎ°ú'; if(h<85)return'ÎùºÏûÑ'; if(h<150)return'Í∑∏Î¶∞'; if(h<190)return'Ï≤≠Î°ù'; if(h<210)return'ÌïòÎäò'; if(h<240)return'Î∏îÎ£®'; if(h<275)return'Ïù∏ÎîîÍ≥†'; if(h<305)return'ÌçºÌîå'; if(h<330)return'ÎßàÏ††ÌÉÄ'; return'ÌïëÌÅ¨';}; return `${tone}${band(h)}`;}
    }
  };

  document.addEventListener('DOMContentLoaded', init);

  function init(){
    loadDB(); refreshPalSelect(); bindEvents(); buildMiniGrid(); rerenderAll();
    const savedTheme=localStorage.getItem('cs-theme')||'dark';
    document.documentElement.setAttribute('data-theme',savedTheme);
    document.getElementById('btn-theme').textContent = savedTheme==='light'?'üåû ÎùºÏù¥Ìä∏':'üåô Îã§ÌÅ¨';
  }

  function loadDB(){
    let db=JSON.parse(localStorage.getItem('palettesDB')||'null');
    if(!db){
      db=[{id:String(Date.now()),name:'Í∏∞Î≥∏ ÌåîÎ†àÌä∏', colors:["#6C5CE7","#10B981","#F59E0B","#EF4444","#3B82F6","#EC4899","#F9FAFB","#6B7280","#111827"].map((c,i)=>({id:String(i),hex:c,name:App.utils.colorNameKo(c),locked:false}))}];
    }
    App.state.palettesDB=db;
    App.state.currentPaletteId=localStorage.getItem('currentPaletteId')||(db.length?db[0].id:null);
  }
  function saveDB(){ localStorage.setItem('palettesDB', JSON.stringify(App.state.palettesDB)); localStorage.setItem('currentPaletteId', App.state.currentPaletteId); }

  function rerenderAll(){
    setCurrentColor(App.state.currentColor);
    setGradientColors(App.state.gradient.start, App.state.gradient.end);
    renderPaletteGrids();
    renderHarmonies();
    renderExtraRegions();
    renderWCAG();
  }
  function refreshPalSelect(){
    const sel=document.getElementById('palSelect'); sel.innerHTML='';
    App.state.palettesDB.forEach(p=>{const o=document.createElement('option'); o.value=p.id; o.textContent=p.name; if(p.id===App.state.currentPaletteId)o.selected=true; sel.appendChild(o);});
  }
  function renderPaletteGrids(){
    renderPalGrid('miniPalGrid');
    renderPalGrid('bigGrid');
    const count=App.state.palette.length;
    document.getElementById('countLabel').textContent=count;
    document.getElementById('countLabel2').textContent=count;
  }
  function renderPalGrid(rootId){
    const root=document.getElementById(rootId); if(!root) return; root.innerHTML='';
    App.state.palette.forEach(p=>{
      const el=document.createElement('div');
      el.className='sw palette-item'+(p.locked?' locked':'');
      el.dataset.id=p.id; el.dataset.hex=p.hex; el.dataset.name=p.name;
      el.innerHTML=`
        <div class="ink" style="background:${p.hex}"></div>
        <div class="swatch-meta">
          <div class="swatch-name" title="${p.name}">${p.name}</div>
          <div class="actions">
            <button class="action-btn" data-action="lock" title="Ïû†Í∏à">${p.locked?'üîí':'üîì'}</button>
            <button class="action-btn" data-action="copy" title="HEX Î≥µÏÇ¨">‚ßâ</button>
            <button class="action-btn" data-action="delete" title="ÏÇ≠Ï†ú">‚úï</button>
          </div>
        </div>`;
      root.appendChild(el);
    });
  }
  function renderWCAG(){
    const a=App.state.currentColor;
    const rW=parseFloat(App.utils.contrastRatio(a,'#FFFFFF').toFixed(2));
    const rB=parseFloat(App.utils.contrastRatio(a,'#000000').toFixed(2));
    const w=document.getElementById('wcagW'), b=document.getElementById('wcagB');
    const build=(ratio,target)=>{
      const status = ratio>=7? {label:'AAA ÌÜµÍ≥º', cls:'pass', note:'AAA (7.0) Í∏∞Ï§Ä Ï∂©Ï°±'}
        : ratio>=4.5? {label:'AA ÌÜµÍ≥º', cls:'pass', note:'AA (4.5) Í∏∞Ï§Ä Ï∂©Ï°±'}
        : ratio>=3? {label:'AA ÎåÄÌòï ÌÖçÏä§Ìä∏', cls:'warn', note:'ÎåÄÌòï ÌÖçÏä§Ìä∏ AA (3.0) Í∏∞Ï§ÄÎßå Ï∂©Ï°±'}
        : {label:'AA ÎØ∏Îã¨', cls:'fail', note:'AA (4.5) Í∏∞Ï§Ä ÎØ∏Îã¨'};
      target.style.background=a;
      target.style.color = target===w? '#FFFFFF':'#000000';
      target.innerHTML=`
        <div class="wcag-title">${target===w?'Î∞ùÏùÄ ÌÖçÏä§Ìä∏ (Ìù∞ÏÉâ)':'Ïñ¥ÎëêÏö¥ ÌÖçÏä§Ìä∏ (Í≤ÄÏ†ï)'}</div>
        <div class="contrast-row">
          <span class="contrast-pill ${status.cls}">${status.label}</span>
          <span class="contrast-value">${ratio.toFixed(2)}:1</span>
        </div>
        <div class="wcag-note">${status.note}</div>`;
    };
    build(rW,w);
    build(rB,b);
  }
  function renderHarmonies(){
    const base=App.state.currentColor, root=document.getElementById('harmonyGrid'); root.innerHTML='';
    const makeCard=(title, colors)=>`
      <div class="panel">
        <h3 style="border:none;padding:12px 18px 0 18px">${title}</h3>
        <div class="content" style="padding-top:8px">
          <div class="swatch-grid">${colors.map(c=>`<div class="sw" data-hex="${c}"><div class="ink" style="background:${c}"></div></div>`).join('')}</div>
          <div class="row-wrap" style="margin-top:8px">
            <button class="btn" data-action="rec-add" data-colors='${JSON.stringify(colors)}'>Î™®Îëê Ï∂îÍ∞Ä</button>
            <button class="btn ghost" data-action="rec-copy" data-colors='${JSON.stringify(colors)}'>HEX Î≥µÏÇ¨</button>
          </div>
        </div>
      </div>`;
    const shift=(d)=>App.utils.shiftHue(base,d);
    const groups = [
      ['Î≥¥ÏÉâ', [base, shift(180)]],
      ['ÏÇºÏÉâ', [base, shift(120), shift(240)]],
      ['Ïú†ÏÇ¨', [shift(-30), base, shift(30)]],
      ['Î™®ÎÖ∏ÌÅ¨Î°¨', [92,80,68,56,44,32,20].map(l=>App.utils.setL(base,l))]
    ];
    root.innerHTML = groups.map(([n, arr]) => makeCard(n, arr)).join('');
  }
  function renderExtraRegions(){
    const base=App.state.currentColor, root=document.getElementById('extraRegions'); root.innerHTML='';
    const shift=(d)=>App.utils.shiftHue(base,d);
    const neutral=createNeutralScale(base);
    const aa=[]; ['#000000','#111827','#FFFFFF','#F9FAFB','#374151'].forEach(txt=>{if(App.utils.contrastRatio(base,txt)>=4.5) aa.push(txt);});
    const groups=[
      ['ÌÖåÌä∏ÎùºÎìú',[base,shift(90),shift(180),shift(270)]],
      ['ÏßÅÏÇ¨Í∞Å(Î≥¥ÏÉâ+Ïú†ÏÇ¨)',[base,shift(180),shift(30),shift(210)]],
      ['Îâ¥Ìä∏Îü¥ Ïä§ÏºÄÏùº',neutral],
      ['UI ÏÉÅÌÉúÏÉâ',[base, App.utils.setS(shift(180),55), '#10B981', '#F59E0B', '#EF4444']],
      ['AA ÏïàÏ†Ñ ÌÖçÏä§Ìä∏', aa.length?aa:['#FFFFFF']]
    ];
    root.innerHTML = groups.map(([name, arr]) => `
      <div class="panel">
        <h3 style="border:none;padding:12px 18px 0 18px">${name}</h3>
        <div class="content" style="padding-top:8px">
          <div class="swatch-grid" style="grid-template-columns:repeat(auto-fill,minmax(44px,1fr))">
            ${arr.map(c=>`<div class="sw" data-hex="${c}"><div class="ink" style="background:${c}"></div></div>`).join('')}
          </div>
          <div class="row-wrap" style="margin-top:8px">
            <button class="btn" data-action="rec-add" data-colors='${JSON.stringify(arr)}'>Î™®Îëê Ï∂îÍ∞Ä</button>
            <button class="btn ghost" data-action="rec-copy" data-colors='${JSON.stringify(arr)}'>HEX Î≥µÏÇ¨</button>
          </div>
        </div>
      </div>`).join('');
  }

  function buildMiniGrid(){
    const grid=document.getElementById('miniGrid'); grid.innerHTML='';
    const hues=Array.from({length:24},(_,i)=>i*15);
    const sats=[40,70]; const lights=[70,50,30];
    hues.forEach(h=>sats.forEach(s=>lights.forEach(l=>{
      const rgb=App.utils.hslToRgb({h,s,l});
      const hex=App.utils.rgbToHex(rgb);
      const cell=document.createElement('div');
      cell.className='mini-cell'; cell.style.background=hex; cell.dataset.hex=hex;
      grid.appendChild(cell);
    })));
  }

  function setCurrentColor(hex, source='internal'){
    if(!/^#[0-9A-Fa-f]{6}$/.test(hex)) return;
    hex=hex.toUpperCase(); App.state.currentColor=hex; App.state.gradient.start=hex;

    const {h,s,l}=App.utils.rgbToHsl(App.utils.hexToRgb(hex));
    const colorEl=document.getElementById('colorInput1'); if(colorEl) colorEl.value=hex;
    const hexEl=document.getElementById('hexInput1'); if(hexEl) hexEl.value=hex;
    document.getElementById('preview1').style.background=hex;
    document.getElementById('hVal').textContent=h+'¬∞';
    document.getElementById('sVal').textContent=s+'%';
    document.getElementById('lVal').textContent=l+'%';
    if(source!=='slider'){
      ['hSl','sSl','lSl'].forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        if(id==='hSl') el.value=h; if(id==='sSl') el.value=s; if(id==='lSl') el.value=l;
      });
    }
    setGradientColors(hex, App.state.gradient.end);
    renderWCAG(); renderHarmonies(); renderExtraRegions();
  }
  function setGradientColors(start,end){
    if(!/^#[0-9A-Fa-f]{6}$/.test(start)||!/^#[0-9A-Fa-f]{6}$/.test(end)) return;
    start=start.toUpperCase(); end=end.toUpperCase(); App.state.gradient={start,end};
    document.getElementById('colorStart').value=start; document.getElementById('hexStart').value=start;
    document.getElementById('colorEnd').value=end; document.getElementById('hexEnd').value=end;
    const css=`linear-gradient(135deg, ${start}, ${end})`;
    document.getElementById('gradPrev').style.background=css;
    document.getElementById('cssCode').textContent=`background: ${css};`;
  }
  function addToPalette(hex,name){
    if(!/^#[0-9A-Fa-f]{6}$/.test(hex)) return;
    hex=hex.toUpperCase();
    const item={id:String(Date.now()+Math.random()),hex,name:name||App.utils.colorNameKo(hex),locked:false};
    App.state.palette.push(item); saveDB(); renderPaletteGrids();
  }
  function bindEvents(){
    document.querySelector('.tabs').addEventListener('click', e=>{
      if(!e.target.matches('.tab-btn')) return;
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      document.querySelectorAll('main > section').forEach(s=>s.hidden=true);
      document.getElementById('tab-'+e.target.dataset.tab).hidden=false;
    });

    document.getElementById('btn-theme').onclick=()=>{
      const cur=document.documentElement.getAttribute('data-theme')==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme',cur);
      localStorage.setItem('cs-theme',cur);
      document.getElementById('btn-theme').textContent = cur==='light'?'üåû ÎùºÏù¥Ìä∏':'üåô Îã§ÌÅ¨';
    };

    document.getElementById('colorInput1').addEventListener('input', e=>setCurrentColor(e.target.value));
    document.getElementById('hexInput1').addEventListener('input', e=>{
      let v=e.target.value.trim();
      if(/^#?[0-9A-Fa-f]{6}$/.test(v)){ if(v[0]!=='#') v='#'+v; setCurrentColor(v);}
    });
    document.getElementById('eyedrop1').onclick=()=>('EyeDropper'in window)? new EyeDropper().open().then(res=>setCurrentColor(res.sRGBHex)).catch(()=>{}):alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî Eyedropper APIÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');

    ['hSl','sSl','lSl'].forEach(id=>document.getElementById(id).addEventListener('input', ()=>{
      const h=+document.getElementById('hSl').value, s=+document.getElementById('sSl').value, l=+document.getElementById('lSl').value;
      document.getElementById('hVal').textContent=h+'¬∞'; document.getElementById('sVal').textContent=s+'%'; document.getElementById('lVal').textContent=l+'%';
      const hex=App.utils.rgbToHex(App.utils.hslToRgb({h,s,l})); setCurrentColor(hex,'slider');
    }));

    document.getElementById('addCurrent').onclick=()=>{ addToPalette(App.state.currentColor); App.utils.toast('ÌåîÎ†àÌä∏Ïóê Ï∂îÍ∞ÄÌñàÏäµÎãàÎã§.'); };

    const openBtn=document.getElementById('openMiniGrid');
    const pop=document.getElementById('miniPopover');
    openBtn.addEventListener('click', ()=>{
      const row=openBtn.getBoundingClientRect();
      pop.style.display='block';
      pop.style.top=(row.bottom+window.scrollY+8)+'px';
      pop.style.left=(row.left+window.scrollX-4)+'px';
    });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') pop.style.display='none'; });
    document.addEventListener('click', (e)=>{
      if(pop.style.display==='block' && !pop.contains(e.target) && e.target.id!=='openMiniGrid') pop.style.display='none';
    });
    document.getElementById('miniGrid').addEventListener('click', e=>{
      const cell=e.target.closest('.mini-cell'); if(!cell) return;
      setCurrentColor(cell.dataset.hex); pop.style.display='none';
    });

    ['colorStart','hexStart'].forEach(id=>document.getElementById(id).addEventListener('input', e=>setGradientColors(e.target.value, App.state.gradient.end)));
    ['colorEnd','hexEnd'].forEach(id=>document.getElementById(id).addEventListener('input', e=>setGradientColors(App.state.gradient.start, e.target.value)));
    document.getElementById('copyCss').onclick=()=>App.utils.copyText(document.getElementById('cssCode').textContent);

    document.getElementById('palSelect').onchange=(e)=>{App.state.currentPaletteId=e.target.value; saveDB(); renderPaletteGrids();}
    document.getElementById('btn-new').onclick=()=>{const name=prompt('ÏÉà ÌåîÎ†àÌä∏ Ïù¥Î¶Ñ','ÏÉà ÌåîÎ†àÌä∏'); if(!name) return; const pal={id:String(Date.now()), name, colors:[]}; App.state.palettesDB.push(pal); App.state.currentPaletteId=pal.id; saveDB(); refreshPalSelect(); renderPaletteGrids();}
    document.getElementById('btn-save').onclick=()=>{saveDB(); App.utils.toast('Ï†ÄÏû•Îê®');}
    document.getElementById('btn-dup').onclick=()=>{const base=App.state.palettesDB.find(p=>p.id===App.state.currentPaletteId); if(!base) return; const np={id:String(Date.now()), name:base.name+' Î≥µÏ†ú', colors:JSON.parse(JSON.stringify(App.state.palette))}; App.state.palettesDB.push(np); App.state.currentPaletteId=np.id; saveDB(); refreshPalSelect(); renderPaletteGrids();}
    document.getElementById('btn-del').onclick=()=>{if(!confirm('ÌòÑÏû¨ ÌåîÎ†àÌä∏Î•º ÏÇ≠Ï†úÌï†ÍπåÏöî?')) return; App.state.palettesDB=App.state.palettesDB.filter(p=>p.id!==App.state.currentPaletteId); if(!App.state.palettesDB.length){App.state.palettesDB=[{id:String(Date.now()), name:'Í∏∞Î≥∏ ÌåîÎ†àÌä∏', colors:[]}];} App.state.currentPaletteId=App.state.palettesDB[0].id; saveDB(); refreshPalSelect(); renderPaletteGrids();}
    document.getElementById('resetUnlocked').onclick=()=>{App.state.palette=App.state.palette.filter(c=>c.locked); saveDB(); renderPaletteGrids();}

    document.body.addEventListener('click', handleClicks);
    document.body.addEventListener('mouseover', handleOver);
    document.body.addEventListener('mouseout', handleOut);

    const fileInput=document.getElementById('fileInput');
    document.getElementById('btn-import').onclick=()=>fileInput.click();
    document.getElementById('btn-export').onclick=exportJSON;
    document.getElementById('btn-export-ase').onclick=exportASE;
    fileInput.onchange=handleFileImport;
    document.getElementById('btn-share').onclick=showShareModal;
    document.getElementById('modal-close-btn').onclick=hideShareModal;
    document.getElementById('modal').onclick=(e)=>{if(e.target.id==='modal') hideShareModal();};
    document.getElementById('copy-url-btn').onclick=()=>{const inp=document.getElementById('share-url'); inp.select(); App.utils.copyText(inp.value);}

    const dz=document.getElementById('imageDropzone');
    dz.onclick=()=>fileInput.click();
    dz.addEventListener('dragover',(e)=>{e.preventDefault(); dz.style.borderColor='var(--pri)';});
    dz.addEventListener('dragleave',()=>dz.style.borderColor='var(--border)');
    dz.addEventListener('drop',(e)=>{e.preventDefault(); dz.style.borderColor='var(--border)'; if(e.dataTransfer.files.length) handleImageFile(e.dataTransfer.files[0]);});

    document.getElementById('btn-drive-auth').onclick=driveAuth;
    document.getElementById('btn-drive-share').onclick=driveSharePalette;
  }

  function handleClicks(e){
    const sw=e.target.closest('.sw');
    if(sw){
      if(sw.closest('#imageResultGrid')){
        sw.classList.toggle('selected');
        return;
      }
      const act=e.target.closest('[data-action]');
      if(act && sw.dataset.id){
        const id=sw.dataset.id; const c=App.state.palette.find(x=>x.id===id); if(!c) return;
        switch(act.dataset.action){
          case'lock': c.locked=!c.locked; saveDB(); renderPaletteGrids(); break;
          case'copy': App.utils.copyText(c.hex); break;
          case'delete': if(c.locked) return App.utils.toast('Ïû†Í∏¥ ÏÉâÏÉÅÏùÄ ÏÇ≠Ï†ú Î∂àÍ∞Ä'); App.state.palette=App.state.palette.filter(x=>x.id!==id); saveDB(); renderPaletteGrids(); break;
        }
        e.stopPropagation(); return;
      } else {
        pinHoverCard(e, sw.dataset.hex, sw.dataset.name||sw.dataset.hex);
      }
    }
    const recBtn = e.target.closest('[data-action^="rec-"]');
    if(recBtn){
      const arr = JSON.parse(recBtn.dataset.colors||'[]');
      if(recBtn.dataset.action==='rec-add'){ arr.forEach(c=>addToPalette(c)); App.utils.toast(`${arr.length}Í∞ú ÏÉâÏÉÅ Ï∂îÍ∞Ä`); }
      if(recBtn.dataset.action==='rec-copy'){ App.utils.copyText(arr.join(', ')); }
    }

    if(e.target.id==='hcAdd') addToPalette(App.state.hoverCard.hex);
    if(e.target.id==='hcCopyHex') App.utils.copyText(App.state.hoverCard.hex);
    if(e.target.id==='hcCopyRgb') App.utils.copyText(document.getElementById('hcRgb').textContent);
    if(e.target.id==='hcPin'){ App.state.hoverCard.pinned=!App.state.hoverCard.pinned; document.getElementById('hoverCard').classList.toggle('pinned',App.state.hoverCard.pinned); document.getElementById('hcPin').textContent=App.state.hoverCard.pinned?'üìç':'üìå';}
    if(e.target.id==='hcClose'){ unpinHoverCard(); }
  }
  function handleOver(e){ const sw=e.target.closest('.sw'); if(sw) showHoverCard(e, sw.dataset.hex, sw.dataset.name||sw.dataset.hex);}
  function handleOut(e){ const sw=e.target.closest('.sw'); if(sw) hideHoverCard();}
  function showHoverCard(e, hex, name){
    if(!hex) return; const hc=document.getElementById('hoverCard'); const rgb=App.utils.hexToRgb(hex);
    App.state.hoverCard.hex=hex;
    document.getElementById('hcTop').style.background=hex;
    document.getElementById('hcName').textContent=name;
    document.getElementById('hcMeta').textContent=hex.toUpperCase();
    document.getElementById('hcHex').textContent=hex.toUpperCase();
    document.getElementById('hcRgb').textContent=`rgb(${rgb.r},${rgb.g},${rgb.b})`;
    hc.style.display='block'; if(!App.state.hoverCard.pinned) moveHoverCard(e);
  }
  function moveHoverCard(e){ const hc=document.getElementById('hoverCard'); const pad=14; let x=e.clientX+pad, y=e.clientY+pad; const rect=hc.getBoundingClientRect(); if(x+rect.width>window.innerWidth) x=e.clientX-rect.width-pad; if(y+rect.height>window.innerHeight) y=e.clientY-rect.height-pad; hc.style.left=x+'px'; hc.style.top=y+'px';}
  function hideHoverCard(){ if(!App.state.hoverCard.pinned) document.getElementById('hoverCard').style.display='none';}
  function pinHoverCard(e,hex,name){ App.state.hoverCard.pinned=true; document.getElementById('hoverCard').classList.add('pinned'); document.getElementById('hcPin').textContent='üìç'; showHoverCard(e,hex,name);}
  function unpinHoverCard(){ App.state.hoverCard.pinned=false; document.getElementById('hoverCard').classList.remove('pinned'); document.getElementById('hcPin').textContent='üìå'; hideHoverCard();}
  function exportJSON(){
    const pal=App.state.palettesDB.find(p=>p.id===App.state.currentPaletteId); if(!pal) return App.utils.toast('ÎÇ¥Î≥¥ÎÇº ÌåîÎ†àÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.');
    const data=JSON.stringify({name:pal.name, colors:App.state.palette}, null, 2);
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download=`${pal.name.replace(/\s/g,'_')}.json`; a.click();
  }
  function exportASE(){
    const pal=App.state.palettesDB.find(p=>p.id===App.state.currentPaletteId); if(!pal||!pal.colors.length) return App.utils.toast('ÎÇ¥Î≥¥ÎÇº ÌåîÎ†àÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.');
    const bytes=[]; const u16=v=>{bytes.push((v>>8)&255, v&255)}, u32=v=>{bytes.push((v>>>24)&255,(v>>>16)&255,(v>>>8)&255,v&255)}, asc=s=>{for(let i=0;i<s.length;i++) bytes.push(s.charCodeAt(i)&255)}, f32=f=>{const b=new ArrayBuffer(4),dv=new DataView(b); dv.setFloat32(0,f,false); bytes.push(dv.getUint8(0),dv.getUint8(1),dv.getUint8(2),dv.getUint8(3));}, ucs=s=>{u16(s.length+1); for(let i=0;i<s.length;i++) u16(s.charCodeAt(i)); u16(0);};
    asc('ASEF'); u16(1); u16(0); u32(pal.colors.length);
    pal.colors.forEach(c=>{
      const name=c.name||c.hex; const buf=[]; const p16=v=>{buf.push((v>>8)&255,v&255)}, p32=v=>{buf.push((v>>>24)&255,(v>>>16)&255,(v>>>8)&255,v&255)}, pAsc=s=>{for(let i=0;i<s.length;i++) buf.push(s.charCodeAt(i)&255)}, pF=f=>{const b=new ArrayBuffer(4),dv=new DataView(b); dv.setFloat32(0,f,false); buf.push(dv.getUint8(0),dv.getUint8(1),dv.getUint8(2),dv.getUint8(3));}, pU=s=>{p16(s.length+1); for(let i=0;i<s.length;i++) p16(s.charCodeAt(i)); p16(0);}
      pU(name); pAsc('RGB ');
      const {r,g,b}=App.utils.hexToRgb(c.hex); pF(r/255); pF(g/255); pF(b/255);
      p16(0x0000);
      u16(0x0001); p32(buf.length); bytes.push(...buf);
    });
    const blob=new Blob([new Uint8Array(bytes)],{type:'application/octet-stream'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${(pal.name||'palette').replace(/\s+/g,'_')}.ase`; a.click();
  }
  function handleFileImport(e){
    const files=e.target.files; if(!files.length) return;
    for(const f of files){
      const ext=f.name.split('.').pop().toLowerCase();
      const r=new FileReader();
      if(ext==='json'){ r.onload=(ev)=>importJSON(ev.target.result); r.readAsText(f);}
      else if(ext==='ase'){ r.onload=(ev)=>importASE(ev.target.result,f.name); r.readAsArrayBuffer(f);}
      else if(f.type.startsWith('image/')){ handleImageFile(f); }
    }
    e.target.value='';
  }
  function importJSON(text){
    try{
      const obj=JSON.parse(text);
      if(obj?.colors?.length){
        const pal={id:String(Date.now()), name:obj.name||'Í∞ÄÏ†∏Ïò® ÌåîÎ†àÌä∏', colors: obj.colors.map((c,i)=>({id:String(i)+'-'+Math.random(), hex:((c.hex||c.color||'#000000')+'').toUpperCase(), name:c.name||App.utils.colorNameKo(c.hex||c.color||'#000000'), locked:!!c.locked}))};
        App.state.palettesDB.push(pal); App.state.currentPaletteId=pal.id; saveDB(); refreshPalSelect(); renderPaletteGrids(); App.utils.toast('JSON Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å');
      } else throw new Error();
    }catch{ App.utils.toast('Ïú†Ìö®Ìïú JSON ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.');}
  }
  function importASE(buf, filename){
    try{
      const dv=new DataView(buf); let off=0; const rd16=()=>{const v=dv.getUint16(off,false); off+=2; return v;}; const rd32=()=>{const v=dv.getUint32(off,false); off+=4; return v;}; const rdStr=()=>{const len=rd16(); let s=''; for(let i=0;i<len-1;i++) s+=String.fromCharCode(dv.getUint16(off+i*2,false)); off+=len*2; return s;};
      const sig=String.fromCharCode(...new Uint8Array(buf,0,4)); if(sig!=='ASEF') throw new Error();
      off=8; const blocks=rd32(); const colors=[];
      for(let i=0;i<blocks;i++){
        const type=rd16(), size=rd32(), end=off+size;
        if(type===0x0001){
          const name=rdStr(); const model=String.fromCharCode(...new Uint8Array(buf,off,4)); off+=4; let r,g,b;
          if(model==='RGB '){ r=Math.round(dv.getFloat32(off,false)*255); off+=4; g=Math.round(dv.getFloat32(off,false)*255); off+=4; b=Math.round(dv.getFloat32(off,false)*255); off+=4; }
          else if(model==='CMYK'){ const c=dv.getFloat32(off,false), m=dv.getFloat32(off+4,false), y=dv.getFloat32(off+8,false), k=dv.getFloat32(off+12,false); r=Math.round(255*(1-c)*(1-k)); g=Math.round(255*(1-m)*(1-k)); b=Math.round(255*(1-y)*(1-k)); off+=16; }
          else if(model==='LAB '){ const L=dv.getFloat32(off,false), aVal=dv.getFloat32(off+4,false), B=dv.getFloat32(off+8,false); let Y=(L+16)/116, X=aVal/500+Y, Z=Y-B/200; const f=t=>t>0.20689655?t*t*t:(t-16/116)/7.787; X=0.95047*f(X); Y=1.0*f(Y); Z=1.08883*f(Z); let R=X*3.2406+Y*-1.5372+Z*-0.4986; let G=X*-0.9689+Y*1.8758+Z*0.0415; let B2=X*0.0557+Y*-0.2040+Z*1.0570; const srgb=t=>t>0.0031308? 1.055*Math.pow(t,1/2.4)-0.055:12.92*t; r=Math.round(srgb(R)*255); g=Math.round(srgb(G)*255); b=Math.round(srgb(B2)*255); off+=12;}
          off=end; colors.push({name, hex: App.utils.rgbToHex({r:App.utils.clamp(r,0,255), g:App.utils.clamp(g,0,255), b:App.utils.clamp(b,0,255)})});
        } else { off=end; }
      }
      if(!colors.length) throw new Error();
      const pal={id:String(Date.now()), name:(filename||'ASE ÌåîÎ†àÌä∏').replace(/\.ase$/i,''), colors: colors.map((c,i)=>({id:String(i)+'-'+Math.random(), hex:c.hex.toUpperCase(), name:c.name||App.utils.colorNameKo(c.hex), locked:false}))};
      App.state.palettesDB.push(pal); App.state.currentPaletteId=pal.id; saveDB(); refreshPalSelect(); renderPaletteGrids(); App.utils.toast('ASE Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å');
    }catch(e){ App.utils.toast('ASE ÌååÏã± Ïã§Ìå®'); }
  }

  function handleImageFile(file){
    if(!file.type.startsWith('image/')) return;
    const r=new FileReader();
    r.onload=(e)=>{ const img=document.getElementById('imagePreview'); img.src=e.target.result; img.style.display='block'; img.onload=()=>extractColors(img); document.getElementById('imageResult').style.display='block'; };
    r.readAsDataURL(file);
  }
  function extractColors(img){
    const c=document.createElement('canvas'), ctx=c.getContext('2d'); const M=120;
    let w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
    if(w>h){ if(w>M){ h=Math.round(h*(M/w)); w=M; } } else { if(h>M){ w=Math.round(w*(M/h)); h=M; } }
    c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
    const data=ctx.getImageData(0,0,w,h).data, map={};
    for(let i=0;i<data.length;i+=4){ if(data[i+3]<128) continue; const R=Math.round(data[i]/16)*16, G=Math.round(data[i+1]/16)*16, B=Math.round(data[i+2]/16)*16; const k=`${R},${G},${B}`; map[k]=(map[k]||0)+1;}
    const top=Object.entries(map).sort(([,a],[,b])=>b-a).slice(0,24).map(([k])=>{const [r,g,b]=k.split(',').map(Number); return App.utils.rgbToHex({r,g,b});});
    const grid=document.getElementById('imageResultGrid');
    grid.innerHTML=top.map(c=>`<div class="sw" data-hex="${c}" data-name="${c}"><div class="ink" style="background:${c}"></div></div>`).join('');
    document.getElementById('addImageToPalette').onclick=()=>{ 
      const sel=[...document.querySelectorAll('#imageResultGrid .sw.selected')].map(x=>x.dataset.hex);
      if(!sel.length) return App.utils.toast('ÏÑ†ÌÉùÎêú ÏÉâÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§.');
      sel.forEach(c=>addToPalette(c)); App.utils.toast(`${sel.length}Í∞ú ÏÉâÏÉÅ Ï∂îÍ∞Ä`);
    };
  }

  function showShareModal(){
    const pal=App.state.palette; if(!pal.length) return App.utils.toast("Í≥µÏú†Ìï† ÏÉâÏÉÅÏù¥ ÏóÜÏäµÎãàÎã§.");
    const hexs=pal.map(c=>c.hex.slice(1)).join(','); const url=`${location.origin}${location.pathname}?palette=${hexs}`;
    document.getElementById('share-url').value=url; const box=document.getElementById('qrcode'); box.innerHTML=''; 
    try{ new QRCode(box,{text:url,width:200,height:200,colorDark:"#111",colorLight:"#fff"});}catch(e){}
    document.getElementById('modal').classList.add('visible'); document.getElementById('modal').setAttribute('aria-hidden','false');
  }
  function hideShareModal(){ document.getElementById('modal').classList.remove('visible'); document.getElementById('modal').setAttribute('aria-hidden','true'); document.getElementById('qrcode').innerHTML=''; }

  function driveAuth(){
    if(!DRIVE_CFG.API_KEY || !DRIVE_CFG.CLIENT_ID) { App.utils.toast('API_KEY/CLIENT_IDÎ•º ÏΩîÎìú ÏÉÅÎã®Ïóê ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.'); return; }
    gapi.load('client:auth2', async ()=>{
      try{
        await gapi.client.init({apiKey: DRIVE_CFG.API_KEY, clientId: DRIVE_CFG.CLIENT_ID, scope: DRIVE_CFG.SCOPE, discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]});
        App.state.gapiInited=true;
        if(!gapi.auth2.getAuthInstance().isSignedIn.get()){
          await gapi.auth2.getAuthInstance().signIn();
        }
        App.state.driveAuthed=true;
        App.utils.toast('Drive Ïó∞Í≤∞ ÏôÑÎ£å');
      }catch(e){ console.error(e); App.utils.toast('Drive Ïó∞Í≤∞ Ïã§Ìå®'); }
    });
  }

  async function driveSharePalette(){
    if(!App.state.driveAuthed){ App.utils.toast('Î®ºÏ†Ä Drive Ïó∞Í≤∞ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî.'); return; }
    const pal=App.state.palettesDB.find(p=>p.id===App.state.currentPaletteId);
    if(!pal || !pal.colors.length) return App.utils.toast('Í≥µÏú†Ìï† ÌåîÎ†àÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.');

    const rootId = await ensureFolder(null, DRIVE_CFG.FOLDER_ROOT);
    const palFolderId = await ensureFolder(rootId, pal.name);

    const jsonText = JSON.stringify({name:pal.name, colors:App.state.palette}, null, 2);
    const jsonBlob = new Blob([jsonText], {type:'application/json'});
    const aseBlob = buildASEBlob(pal.colors);

    await uploadToDrive(palFolderId, `${pal.name}.json`, jsonBlob, 'application/json');
    await uploadToDrive(palFolderId, `${pal.name}.ase`,  aseBlob,  'application/octet-stream');

    await setPermissionAnyone(palFolderId);
    const link = `https://drive.google.com/drive/folders/${palFolderId}`;
    navigator.clipboard?.writeText(link);
    App.utils.toast('Drive Í≥µÏú† ÎßÅÌÅ¨Î•º ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÌñàÏäµÎãàÎã§.');
    document.getElementById('share-url').value = link;
    const box=document.getElementById('qrcode'); box.innerHTML='';
    try{ new QRCode(box,{text:link,width:200,height:200,colorDark:"#111",colorLight:"#fff"});}catch(e){}
    document.getElementById('modal').classList.add('visible'); document.getElementById('modal').setAttribute('aria-hidden','false');
  }

  function buildASEBlob(colors){
    const bytes=[]; const u16=v=>{bytes.push((v>>8)&255, v&255)}, u32=v=>{bytes.push((v>>>24)&255,(v>>>16)&255,(v>>>8)&255,v&255)}, asc=s=>{for(let i=0;i<s.length;i++) bytes.push(s.charCodeAt(i)&255)}, f32=f=>{const b=new ArrayBuffer(4),dv=new DataView(b); dv.setFloat32(0,f,false); bytes.push(dv.getUint8(0),dv.getUint8(1),dv.getUint8(2),dv.getUint8(3));}, ucs=s=>{u16(s.length+1); for(let i=0;i<s.length;i++) u16(s.charCodeAt(i)); u16(0);};
    asc('ASEF'); u16(1); u16(0); u32(colors.length);
    colors.forEach(c=>{
      const name=c.name||c.hex; const buf=[]; const p16=v=>{buf.push((v>>8)&255,v&255)}, p32=v=>{buf.push((v>>>24)&255,(v>>>16)&255,(v>>>8)&255,v&255)}, pAsc=s=>{for(let i=0;i<s.length;i++) buf.push(s.charCodeAt(i)&255)}, pF=f=>{const b=new ArrayBuffer(4),dv=new DataView(b); dv.setFloat32(0,f,false); buf.push(dv.getUint8(0),dv.getUint8(1),dv.getUint8(2),dv.getUint8(3));}, pU=s=>{p16(s.length+1); for(let i=0;i<s.length;i++) p16(s.charCodeAt(i)); p16(0);}
      pU(name); pAsc('RGB ');
      const {r,g,b}=App.utils.hexToRgb(c.hex); pF(r/255); pF(g/255); pF(b/255);
      p16(0x0000);
      u16(0x0001); p32(buf.length); bytes.push(...buf);
    });
    return new Blob([new Uint8Array(bytes)],{type:'application/octet-stream'});
  }

  async function ensureFolder(parentId, name){
    const qParts = [`mimeType='application/vnd.google-apps.folder'`, `name='${name.replace(/'/g,"\\'")}'`, 'trashed=false'];
    if(parentId) qParts.push(`'${parentId}' in parents`);
    const res = await gapi.client.drive.files.list({q: qParts.join(' and '), fields:'files(id,name)'});
    if(res.result.files && res.result.files.length) return res.result.files[0].id;
    const created = await gapi.client.drive.files.create({
      resource: {name, mimeType:'application/vnd.google-apps.folder', parents: parentId? [parentId]: undefined},
      fields:'id'
    });
    return created.result.id;
  }
  async function uploadToDrive(parentId, name, blob, mime){
    const metadata = { name, mimeType: mime, parents: [parentId] };
    const boundary = '-------314159265358979323846';
    const delimiter = "\r\n--" + boundary + "\r\n";
    const closeDelim = "\r\n--" + boundary + "--";
    const reader = await blob.arrayBuffer();
    const base64Data = btoa(String.fromCharCode(...new Uint8Array(reader)));
    const multipartRequestBody =
      delimiter + 'Content-Type: application/json\r\n\r\n' +
      JSON.stringify(metadata) +
      delimiter + 'Content-Type: ' + mime + '\r\n' +
      'Content-Transfer-Encoding: base64\r\n\r\n' +
      base64Data + closeDelim;

    const res = await gapi.client.request({
      path:'/upload/drive/v3/files',
      method:'POST',
      params:{uploadType:'multipart'},
      headers:{'Content-Type': 'multipart/related; boundary="' + boundary + '"'},
      body: multipartRequestBody
    });
    return res.result;
  }
  async function setPermissionAnyone(fileId){
    try{
      await gapi.client.drive.permissions.create({
        fileId, resource:{role:'reader', type:'anyone'}
      });
    }catch(e){ }
  }

  function createNeutralScale(base){
    const baseHsl=App.utils.rgbToHsl(App.utils.hexToRgb(base));
    const hue=baseHsl.h;
    const satBase=App.utils.clamp(Math.round(baseHsl.s*0.35), 6, 28);
    const lightSteps=[94,88,82,76,70,64,58,52,46];
    return lightSteps.map((l,idx)=>{
      const sat=Math.max(4, Math.round(satBase - idx*1.6));
      const tinted=App.utils.hslToRgb({h:hue, s:sat, l});
      return App.utils.rgbToHex(tinted);
    });
  }
})();
</script>
</body>
</html>
